<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Taxas de Cr√©dito - Cooperativa</title>
    <style>
        /* DESIGN SYSTEM - CORPORATE BANKING */
        :root {
            --primary-color: #003366; /* Azul Marinho Institucional */
            --secondary-color: #005b96;
            --bg-page: #f4f7f9;
            --border-radius: 6px;
            --text-dark: #333;
            --border-color: #ccc;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-page);
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* CABE√áALHO */
        header {
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 30px;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.8rem;
        }

        /* SE√á√ïES */
        fieldset {
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            background-color: #fff;
        }

        legend {
            font-weight: bold;
            color: var(--secondary-color);
            padding: 0 10px;
            font-size: 1.1rem;
        }

        /* GRID FORM */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #555;
        }

        input, select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 3px rgba(0, 51, 102, 0.2);
        }

        .rate-display {
            font-size: 0.85rem;
            color: var(--secondary-color);
            font-weight: bold;
            margin-top: 4px;
        }

        /* CHECKBOXES */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            background: #fafafa;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .checkbox-item input {
            margin-right: 8px;
            width: auto;
        }

        /* RESULTADOS */
        .result-panel {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 30px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .result-item small {
            display: block;
            color: #666;
            margin-bottom: 5px;
        }

        .result-item .value {
            font-size: 1.6rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .total-desconto {
            color: #2e7d32 !important; /* Verde */
        }

        /* BOT√ïES */
        .actions {
            margin-top: 30px;
            text-align: right;
        }

        .btn-print {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-print:hover {
            background-color: var(--secondary-color);
        }

        /* IMPRESS√ÉO */
        @media print {
            body {
                background: white;
                padding: 0;
                font-size: 12px;
            }
            .container {
                box-shadow: none;
                padding: 0;
                width: 100%;
                max-width: 100%;
            }
            .no-print, .actions {
                display: none !important;
            }
            fieldset {
                border: 1px solid #999;
                margin-bottom: 15px;
                padding: 10px;
                page-break-inside: avoid;
            }
            input, select {
                border: none;
                background: transparent;
                padding: 0;
                font-weight: bold;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            /* Esconde √≠cone do select */
            select {
                background-image: none;
            }
            .checkbox-group {
                border: none;
                background: none;
                display: block;
            }
            .checkbox-item {
                display: inline-block;
                margin-right: 15px;
            }
            .checkbox-item input {
                display: none;
            }
            /* S√≥ mostra os marcados na impress√£o ou estiliza check */
            .checkbox-item input:checked + span::before {
                content: "‚òë ";
            }
            .checkbox-item input:not(:checked) + span::before {
                content: "‚òê ";
            }
            .checkbox-item {
                /* Esconde o input original visualmente */
            }
            .result-panel {
                background: none;
                border: 2px solid #000;
            }
            h1 { font-size: 1.4rem; }
            .rate-display { color: #000; font-weight: normal; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Simulador de Taxa de Cr√©dito</h1>
        <div class="no-print" style="font-size: 0.9rem; color: #666;">
            Preencha os dados abaixo para gerar a proposta.
        </div>
    </header>

    <fieldset>
        <legend>1. Dados do Cooperado</legend>
        <div class="form-row">
            <div class="form-group">
                <label for="nome">Nome Completo</label>
                <input type="text" id="nome" placeholder="Nome do associado">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="cpf">CPF / CNPJ</label>
                <input type="text" id="cpf" placeholder="000.000.000-00">
            </div>
            <div class="form-group">
                <label for="conta">N√∫mero da Conta</label>
                <input type="text" id="conta" placeholder="00000-0">
            </div>
            <div class="form-group">
                <label for="dataAssociacao">Data de Associa√ß√£o</label>
                <input type="date" id="dataAssociacao" onchange="calcular()">
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>2. Dados da Proposta</legend>
        <div class="form-row">
            <div class="form-group">
                <label for="modelo">Modelo de Cr√©dito</label>
                <select id="modelo" onchange="calcular()">
                    <option value="12">Modelo 12</option>
                    <option value="20">Modelo 20</option>
                    <option value="3614">Modelo 3614</option>
                    <option value="3616">Modelo 3616</option>
                    <option value="3618">Modelo 3618</option>
                    <option value="28">Modelo 28</option>
                    <option value="25">Modelo 25</option>
                    <option value="3620">Modelo 3620</option>
                </select>
                <div id="taxaModeloDisplay" class="rate-display">Taxa: --</div>
            </div>
            <div class="form-group">
                <label for="valorProposta">Valor da Proposta (R$)</label>
                <input type="text" id="valorProposta" placeholder="0,00" onkeyup="mascaraMoeda(this); calcular()">
            </div>
            <div class="form-group">
                <label for="prazoMeses">Prazo (Meses)</label>
                <input type="number" id="prazoMeses" value="12" onchange="calcular()">
            </div>
            <div class="form-group">
                <label for="modalidade">Modalidade</label>
                <select id="modalidade" onchange="calcular()">
                    <option value="Urbano">Urbano</option>
                    <option value="Rural">Rural</option>
                    <option value="PJ">Pessoa Jur√≠dica</option>
                </select>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>3. Informa√ß√µes Financeiras (Conglomerado/S√≥cio)</legend>
        <div class="form-row">
            <div class="form-group">
                <label for="rendaMensal">Renda Mensal</label>
                <input type="text" id="rendaMensal" placeholder="0,00" onkeyup="mascaraMoeda(this); calcular()">
            </div>
            <div class="form-group">
                <label for="patrimonio">Patrim√¥nio</label>
                <input type="text" id="patrimonio" placeholder="0,00" onkeyup="mascaraMoeda(this); calcular()">
            </div>
            <div class="form-group">
                <label for="capital">Capital (S√≥cio)</label>
                <input type="text" id="capital" placeholder="0,00" onkeyup="mascaraMoeda(this); calcular()">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="endividamentoCoop">Endividamento (Na Cooperativa)</label>
                <input type="text" id="endividamentoCoop" placeholder="0,00" onkeyup="mascaraMoeda(this); calcular()">
            </div>
            <div class="form-group">
                <label for="endividamentoSCR">Endividamento SCR (1 ano)</label>
                <input type="text" id="endividamentoSCR" placeholder="0,00" onkeyup="mascaraMoeda(this); calcular()">
            </div>
            <div class="form-group">
                <label for="endividamentoSCRAcima">SCR (Acima de 1 ano)</label>
                <input type="text" id="endividamentoSCRAcima" placeholder="0,00" onkeyup="mascaraMoeda(this); calcular()">
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>4. Vari√°veis de Relacionamento e Risco</legend>
        
        <div class="form-row">
            <div class="form-group" style="flex: 2;">
                <label>Produtos e Servi√ßos Contratados</label>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Cart√£o</span></div>
                    <div class="checkbox-item"><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Internet Banking</span></div>
                    <div class="checkbox-item"><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Seguro</span></div>
                    <div class="checkbox-item"><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Cons√≥rcio</span></div>
                    <div class="checkbox-item"><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Aplica√ß√£o</span></div>
                    <div class="checkbox-item"><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Empr√©stimo</span></div>
                    <div class="checkbox-item"><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Boleto</span></div>
                    <div class="checkbox-item"><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Limite Conta</span></div>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="riscoSocio">Risco do S√≥cio</label>
                <select id="riscoSocio" onchange="calcular()">
                    <option value="AA">AA</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="G">G</option>
                    <option value="H">H</option>
                </select>
            </div>
            <div class="form-group">
                <label for="riscoOperacao">Risco da Opera√ß√£o</label>
                <select id="riscoOperacao" onchange="calcular()">
                    <option value="AA">AA</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="G">G</option>
                    <option value="H">H</option>
                </select>
            </div>
            <div class="form-group">
                <label for="recebimento">Recebimento (Sal√°rio/Receita)</label>
                <select id="recebimento" onchange="calcular()">
                    <option value="nao">N√£o</option>
                    <option value="sim">Sim</option>
                </select>
            </div>
        </div>
    </fieldset>

    <div class="result-panel">
        <h3 style="margin-top:0; border-bottom:1px solid #ccc; padding-bottom:10px;">Resultado da Simula√ß√£o</h3>
        <div class="result-grid">
            <div class="result-item">
                <small>Taxa Base (M√™s)</small>
                <span class="value" id="outTaxaPadrao">0,00%</span>
            </div>
            <div class="result-item">
                <small>Total de Descontos</small>
                <span class="value total-desconto" id="outTotalDescontos">0,00%</span>
            </div>
            <div class="result-item" style="background: #eef2f5; border-radius: 4px;">
                <small>Taxa Final (M√™s)</small>
                <span class="value" id="outTaxaFinalMes">0,00%</span>
            </div>
            <div class="result-item">
                <small>Taxa Final (Ano)</small>
                <span class="value" id="outTaxaFinalAno">0,00%</span>
            </div>
        </div>
        <div id="debugDescontos" style="margin-top: 15px; font-size: 0.8rem; color: #777; border-top: 1px solid #ddd; padding-top: 10px;">
            </div>
    </div>

    <div class="actions">
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimir / Gerar PDF</button>
    </div>

</div>

<script>
    // --- DADOS E TABELAS ---
    const MODELOS = {
        "12": { taxa: 0.0220, anual: false },
        "20": { taxa: 0.0400, anual: false },
        "3614": { taxa: 0.1800, anual: true },
        "3616": { taxa: 0.1400, anual: true },
        "3618": { taxa: 0.0300, anual: false },
        "28": { taxa: 0.0400, anual: false },
        "25": { taxa: 0.0500, anual: false },
        "3620": { taxa: 0.0400, anual: false }
    };

    // Tabelas de Refer√™ncia
    const TABELA_CAPITAL_ENDIVIDAMENTO = [
        { min: 0, val: 0.10 },
        { min: 0.05, val: 0.07 },
        { min: 0.10, val: 0.035 },
        { min: 0.21, val: 0.00 }
    ];

    // INVERTIDA conforme solicita√ß√£o: Valores baixos d√£o 0%
    const TABELA_ENDIVIDAMENTO_PATRIMONIO = [
        { min: 0, val: 0.00 },
        { min: 0.2, val: 0.015 },
        { min: 0.4, val: 0.03 },
        { min: 0.6, val: 0.045 },
        { min: 1.0, val: 0.07 }
    ];

    const TABELA_PRODUTOS = [
        { min: 0, val: 0.00 },
        { min: 1, val: 0.0125 },
        { min: 2, val: 0.0250 },
        { min: 3, val: 0.0375 },
        { min: 4, val: 0.0500 }
    ];

    const TABELA_TEMPO_ASSOC = [
        { min: 0, val: 0.00 },
        { min: 1, val: 0.015 },
        { min: 5, val: 0.030 },
        { min: 10, val: 0.050 }
    ];

    const TABELA_PRAZO_OP = [
        { min: 0, val: 0.04 },
        { min: 13, val: 0.03 },
        { min: 25, val: 0.02 },
        { min: 37, val: 0.01 },
        { min: 49, val: 0.00 }
    ];

    const TABELA_ENDIV_RENDA_URBANO = [
        { min: 0, val: 0.07 },
        { min: 0.1, val: 0.04 },
        { min: 0.2, val: 0.02 },
        { min: 0.3, val: 0.00 }
    ];

    const TABELA_PRONAF_RURAL = [
        { min: 0, val: 0.07 },
        { min: 0.3, val: 0.04 },
        { min: 0.5, val: 0.02 },
        { min: 0.7, val: 0.00 }
    ];

    // --- UTILS ---
    function mascaraMoeda(i) {
        var v = i.value.replace(/\D/g,'');
        v = (v/100).toFixed(2) + '';
        v = v.replace(".", ",");
        v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        i.value = v;
    }

    function parseCurrency(str) {
        if (!str) return 0;
        return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
    }

    function procvAproximado(valor, tabela) {
        let resultado = 0;
        // Busca padr√£o: encontra o maior 'min' que √© menor ou igual ao 'valor'
        for (let i = 0; i < tabela.length; i++) {
            if (valor >= tabela[i].min) {
                resultado = tabela[i].val;
            } else {
                break;
            }
        }
        return resultado;
    }

    function getDescontoRisco(letra) {
        const tabela = { "AA": 0.05, "A": 0.05, "B": 0.05, "C": 0.02 };
        return tabela[letra] || 0;
    }

    function formatPercent(val) {
        return (val * 100).toFixed(2).replace('.', ',') + '%';
    }

    // --- L√ìGICA ---
    function calcular() {
        // 1. Atualizar display da taxa modelo
        const modeloId = document.getElementById('modelo').value;
        const modeloDados = MODELOS[modeloId];
        let taxaPadraoMes = 0;
        let taxaPadraoAno = 0;

        if (modeloDados.anual) {
            taxaPadraoAno = modeloDados.taxa;
            taxaPadraoMes = Math.pow((1 + modeloDados.taxa), (1/12)) - 1;
        } else {
            taxaPadraoMes = modeloDados.taxa;
            taxaPadraoAno = Math.pow((1 + modeloDados.taxa), 12) - 1;
        }

        document.getElementById('taxaModeloDisplay').innerText = 
            `Ref: ${formatPercent(taxaPadraoMes)} a.m. | ${formatPercent(taxaPadraoAno)} a.a.`;

        // 2. Coletar valores
        const valorProposta = parseCurrency(document.getElementById('valorProposta').value);
        const rendaMensal = parseCurrency(document.getElementById('rendaMensal').value);
        const patrimonio = parseCurrency(document.getElementById('patrimonio').value);
        const capital = parseCurrency(document.getElementById('capital').value);
        const endividamentoCoop = parseCurrency(document.getElementById('endividamentoCoop').value);
        const endividamentoSCR = parseCurrency(document.getElementById('endividamentoSCR').value);
        const prazoMeses = parseInt(document.getElementById('prazoMeses').value) || 0;

        // 3. C√°lculos de Descontos
        let descontos = {};

        // Capital x Endividamento (SCR 1 ano)
        let ratioCapEndiv = (endividamentoSCR > 0) ? (capital + valorProposta) / endividamentoSCR : 999;
        descontos['Capital/Endiv'] = procvAproximado(ratioCapEndiv, TABELA_CAPITAL_ENDIVIDAMENTO);

        // Endividamento (Proposta + Coop) x Patrim√¥nio
        // L√≥gica Invertida: Se ratio < 0.2, retorna 0%. 
        let ratioEndivPat = (patrimonio > 0) ? (valorProposta + endividamentoCoop) / patrimonio : 999;
        descontos['Endiv/Patr'] = procvAproximado(ratioEndivPat, TABELA_ENDIVIDAMENTO_PATRIMONIO);

        // Produtos
        const qtdProdutos = document.querySelectorAll('.prod-check:checked').length;
        descontos['Produtos'] = procvAproximado(qtdProdutos, TABELA_PRODUTOS);

        // Riscos e Recebimento
        descontos['Risco S√≥cio'] = getDescontoRisco(document.getElementById('riscoSocio').value);
        descontos['Risco Opera√ß√£o'] = getDescontoRisco(document.getElementById('riscoOperacao').value);
        descontos['Recebimento'] = document.getElementById('recebimento').value === 'sim' ? 0.02 : 0.00;

        // Tempo Associa√ß√£o
        const dataStr = document.getElementById('dataAssociacao').value;
        let anosAssoc = 0;
        if (dataStr) {
            const diff = new Date() - new Date(dataStr);
            anosAssoc = diff / (1000 * 60 * 60 * 24 * 365);
        }
        descontos['Tempo Assoc'] = procvAproximado(anosAssoc, TABELA_TEMPO_ASSOC);

        // Prazo e Modalidade
        descontos['Prazo'] = procvAproximado(prazoMeses, TABELA_PRAZO_OP);

        let ratioCapacidade = 0;
        if (rendaMensal > 0 && prazoMeses > 0) {
            const parcelaTotal = (endividamentoCoop / 12) + (valorProposta / prazoMeses);
            ratioCapacidade = parcelaTotal / rendaMensal;
        }
        const mod = document.getElementById('modalidade').value;
        descontos['Modalidade'] = procvAproximado(ratioCapacidade, 
            (mod === 'Urbano') ? TABELA_ENDIV_RENDA_URBANO : TABELA_PRONAF_RURAL
        );

        // 4. Somat√≥rio e Resultado Final
        let totalDesc = 0;
        let debugHtml = "<strong>Detalhamento:</strong> ";
        for (let [k, v] of Object.entries(descontos)) {
            totalDesc += v;
            debugHtml += `${k}: ${formatPercent(v)} | `;
        }
        
        // Aplica√ß√£o do desconto: TaxaFinal = Base - (Base * %Desconto)
        let taxaFinalMes = taxaPadraoMes - (taxaPadraoMes * totalDesc);
        if (taxaFinalMes < 0) taxaFinalMes = 0;
        
        let taxaFinalAno = Math.pow((1 + taxaFinalMes), 12) - 1;

        // 5. Sa√≠da
        document.getElementById('outTaxaPadrao').innerText = formatPercent(taxaPadraoMes);
        document.getElementById('outTotalDescontos').innerText = formatPercent(totalDesc);
        document.getElementById('outTaxaFinalMes').innerText = formatPercent(taxaFinalMes);
        document.getElementById('outTaxaFinalAno').innerText = formatPercent(taxaFinalAno);
        document.getElementById('debugDescontos').innerHTML = debugHtml;
    }

    // Init
    window.onload = calcular;
</script>

</body>
</html>