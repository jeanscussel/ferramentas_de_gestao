<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama de Ishikawa - Completo</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- ESTILOS GERAIS --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { color: #333; margin-bottom: 10px; }

        /* --- CONTROLES --- */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
            width: 100%;
            max-width: 900px;
            z-index: 100; 
        }

        input[type="text"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 35%;
            margin-right: 10px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            margin: 5px;
            transition: background 0.2s;
        }
        
        /* Cores dos Bot√µes */
        .btn-primary { background-color: #007bff; } /* Azul (Adicionar) */
        .btn-primary:hover { background-color: #0056b3; }
        
        .btn-success { background-color: #28a745; } /* Verde (Baixar) */
        .btn-success:hover { background-color: #218838; }

        .btn-danger { background-color: #dc3545; } /* Vermelho (Limpar) */
        .btn-danger:hover { background-color: #c82333; }

        /* --- O DIAGRAMA (GRID/FLEX REFORMULADO) --- */
        .diagram-wrapper {
            width: 98%;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            overflow: auto; 
        }

        .fish-container {
            display: flex;
            align-items: stretch; 
            width: max-content; 
            margin: 0 auto;
            padding: 20px;
            background: white; 
        }

        /* --- COLUNA DE CATEGORIA --- */
        .fish-column {
            display: flex;
            flex-direction: column;
            min-width: 200px; 
        }

        .half-section {
            flex: 1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            min-height: 150px; 
        }

        .top-section { justify-content: flex-end; }
        .bottom-section { justify-content: flex-start; }

        .spine-segment {
            height: 4px;
            background-color: #2c3e50;
            width: 100%;
            position: relative;
        }

        /* --- ELEMENTOS VISUAIS --- */
        .category-box {
            background-color: #4ecdc4;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            width: 140px;
            text-align: center;
            border: 2px solid #2c3e50;
            position: relative;
            z-index: 10;
        }
        .category-box:hover { background-color: #3dbdb4; }

        .vertical-line {
            width: 4px;
            height: 40px;
            background-color: #2c3e50;
        }

        .causes-list {
            display: flex;
            flex-direction: column; 
            gap: 5px;
            margin: 10px 0;
        }
        
        .top-section .causes-list { flex-direction: column-reverse; }

        .cause-item {
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 6px;
            font-size: 0.9em;
            border-radius: 3px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            width: 150px;
            text-align: left;
            position: relative;
        }

        /* --- CABE√áA DO PEIXE --- */
        .head-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-left: 5px;
        }

        .head-problem {
            width: 200px;
            height: 120px;
            background-color: #ff6b6b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
            padding: 10px;
            border: 2px solid #c0392b;
            position: relative;
        }

        .head-problem::before {
            content: '';
            position: absolute;
            left: -20px; top: 50%; transform: translateY(-50%);
            width: 0; height: 0; 
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-right: 20px solid #ff6b6b; 
        }
        .head-problem::after {
            content: '';
            position: absolute;
            left: -23px; top: 50%; transform: translateY(-50%);
            width: 0; height: 0; 
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-right: 20px solid #c0392b; 
            z-index: -1;
        }

        /* --- BOT√ïES DE REMOVER (ITEM INDIVIDUAL) --- */
        .delete-btn {
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px; height: 20px;
            font-size: 12px;
            position: absolute;
            top: -8px; right: -8px;
            display: none;
            cursor: pointer;
        }
        .category-box:hover .delete-btn { display: block; }

        .delete-cause-btn {
            float: right;
            background: #ffebeb;
            color: red;
            border: none; font-size: 10px; cursor: pointer;
            margin-left: 5px;
        }
    </style>
</head>
<body>

    <h1>Diagrama de Ishikawa</h1>

    <div class="controls">
        <div>
            <label><strong>Problema:</strong></label>
            <input type="text" id="problemInput" placeholder="Ex: Falha na produ√ß√£o" oninput="updateProblem()">
        </div>
        <br>
        <div>
            <input type="text" id="categoryInput" placeholder="Nova Categoria (Ex: Material)">
            <button class="btn-primary" onclick="addCategory()">+ Categoria</button>
            <button class="btn-success" onclick="downloadDiagram()">üì∑ Baixar Imagem</button>
            <button class="btn-danger" onclick="clearDiagram()">üóëÔ∏è Limpar Tudo</button>
        </div>
        <p style="font-size: 0.8em; color: #666; margin-top: 10px;">
            Clique nas caixas azuis para inserir causas. O diagrama cresce automaticamente.
        </p>
    </div>

    <div class="diagram-wrapper">
        <div class="fish-container" id="captureArea">
            
            <div id="bones-area" style="display: flex;"></div>

            <div class="head-section">
                <div class="head-problem" id="problemDisplay">
                    Problema Principal
                </div>
            </div>

        </div>
    </div>

    <script>
        function updateProblem() {
            const text = document.getElementById('problemInput').value;
            document.getElementById('problemDisplay').textContent = text || "Problema Principal";
        }

        function addCategory() {
            const input = document.getElementById('categoryInput');
            const categoryName = input.value;
            if (categoryName.trim() === "") { alert("Digite um nome para a categoria."); return; }

            const bonesArea = document.getElementById('bones-area');
            const index = bonesArea.children.length;
            const isTop = index % 2 === 0; 

            const column = document.createElement('div');
            column.className = 'fish-column';

            let topContent = '';
            let bottomContent = '';

            const contentHtml = `
                <div class="causes-list"></div>
                <div class="category-box" onclick="addCause(this)">
                    ${categoryName}
                    <button class="delete-btn" onclick="removeElement(event, this.parentElement.parentElement.parentElement.parentElement)">X</button>
                </div>
                <div class="vertical-line"></div>
            `;

            if (isTop) {
                topContent = contentHtml;
            } else {
                bottomContent = `
                    <div class="vertical-line"></div>
                    <div class="category-box" onclick="addCause(this)">
                        ${categoryName}
                        <button class="delete-btn" onclick="removeElement(event, this.parentElement.parentElement.parentElement.parentElement)">X</button>
                    </div>
                    <div class="causes-list"></div>
                `;
            }

            column.innerHTML = `
                <div class="half-section top-section">
                    ${topContent}
                </div>
                <div class="spine-segment"></div>
                <div class="half-section bottom-section">
                    ${bottomContent}
                </div>
            `;

            bonesArea.appendChild(column);
            input.value = "";
            input.focus();
        }

        function addCause(categoryBox) {
            const causeText = prompt("Adicionar causa em: " + categoryBox.childNodes[0].textContent.trim());
            if (causeText && causeText.trim() !== "") {
                const parentSection = categoryBox.parentElement; 
                const list = parentSection.querySelector('.causes-list');
                const causeItem = document.createElement('div');
                causeItem.className = 'cause-item';
                causeItem.innerHTML = `
                    ${causeText}
                    <button class="delete-cause-btn" onclick="removeElement(event, this.parentElement)">x</button>
                `;
                list.appendChild(causeItem);
            }
        }

        function removeElement(event, element) {
            event.stopPropagation();
            if (confirm("Remover este item?")) {
                element.remove();
            }
        }

        // --- FUN√á√ÉO PARA LIMPAR TUDO ---
        function clearDiagram() {
            if(confirm("ATEN√á√ÉO: Tem certeza que deseja limpar todo o diagrama?\nIsso apagar√° todas as categorias e causas.")) {
                // 1. Limpa as espinhas
                document.getElementById('bones-area').innerHTML = "";
                
                // 2. Limpa o Input de texto
                document.getElementById('problemInput').value = "";
                
                // 3. Reseta a cabe√ßa do peixe
                document.getElementById('problemDisplay').innerText = "Problema Principal";
            }
        }

        function downloadDiagram() {
            const element = document.getElementById('captureArea');
            const originalBtnText = event.target.innerText;
            event.target.innerText = "Gerando imagem...";

            html2canvas(element, {
                backgroundColor: "#ffffff",
                scale: 2, 
                scrollX: 0,
                scrollY: -window.scrollY, 
                windowWidth: document.documentElement.scrollWidth,
                windowHeight: document.documentElement.scrollHeight
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'diagrama-ishikawa.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
                event.target.innerText = originalBtnText;
            });
        }
    </script>
</body>
</html>