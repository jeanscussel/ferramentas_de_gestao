<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Taxa - Cooperativa (V8 Print Fix)</title>
    <style>
        :root {
            --primary: #007141;
            --secondary: #67BD50;
            --complement: #F58634;
            --bg: #f5f7fa;
            --text: #333;
            --border: #dde2e6;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 850px;
            margin: 0 auto;
            background: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-placeholder {
            max-height: 50px;
            width: auto;
            display: block;
        }

        .header h1 {
            color: var(--primary);
            margin: 0;
            font-size: 1.6rem;
            line-height: 1.2;
        }

        /* FORM SECTIONS */
        .section-title {
            background-color: #f0f4f8;
            color: var(--primary);
            padding: 10px 15px;
            font-weight: bold;
            border-left: 4px solid var(--secondary);
            margin-top: 30px;
            margin-bottom: 20px;
            border-radius: 0 4px 4px 0;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .col {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        input, select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
            background: #fff;
            transition: border 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .rate-badge {
            display: inline-block;
            background: #ffffff;
            color: var(--complement);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* CHECKBOXES */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            background: #fafafa;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .checkbox-item label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
            margin: 0;
        }

        .checkbox-item input {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }

        /* RESULTADOS */
        .result-box {
            margin-top: 40px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            overflow: hidden;
        }

        .result-header {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            font-weight: bold;
        }

        .result-content {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 20px;
            background: #fff;
            gap: 20px;
            text-align: center;
        }

        .result-metric small {
            display: block;
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .result-metric .value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary);
        }

        .discount-value { color: #2e7d32 !important; }

        .debug-row {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: #666;
        }

        /* ACTIONS */
        .actions {
            margin-top: 30px;
            text-align: right;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover { background: var(--secondary); }
    </style>
</head>
<body>

<div class="container" id="printableArea">
    <div class="header">
        <div class="header-left">
            <img src="https://github.com/jeanscussel/ferramentas_de_gestao/blob/main/logotipo.png?raw=true" 
                 alt="Logo da Cooperativa" 
                 class="logo-placeholder">
            
            <div>
                <h1>Calculadora de Taxas</h1>
                <span style="font-size:0.9rem; color:#666">Preencha os campos para calcular</span>
            </div>
        </div>
        <div style="text-align: right; font-size: 0.8rem;">
            Data da Simulação:<br>
            <strong id="dataHoje">--/--/----</strong>
        </div>
    </div>

    <div class="section-title">1. Dados do Cooperado</div>
    <div class="row">
        <div class="col">
            <label>Nome Completo</label>
            <input type="text" id="nome" placeholder="Nome e sobrenome">
        </div>
        <div class="col">
            <label>CPF / CNPJ</label>
            <input type="text" id="cpf" placeholder="CPF ou CNPJ" maxlength="18" oninput="mascaraCpfCnpj(this)">
        </div>
    </div>
    <div class="row">
        <div class="col">
            <label>Número da Conta</label>
            <input type="text" id="conta" placeholder="00000-0">
        </div>
        <div class="col">
            <label>Data de Associação</label>
            <input type="date" id="dataAssociacao" onchange="calcular()">
        </div>
    </div>

    <div class="section-title">2. Dados da Proposta</div>
    <div class="row">
        <div class="col">
            <label>Modelo de Crédito</label>
            <select id="modelo" onchange="calcular()">
                <option value="12">Modelo 12</option>
                <option value="20">Modelo 20</option>
                <option value="3614">Modelo 3614 (Anual)</option>
                <option value="3616">Modelo 3616 (Anual)</option>
                <option value="3618">Modelo 3618</option>
                <option value="28">Modelo 28</option>
                <option value="25">Modelo 25</option>
                <option value="3620">Modelo 3620</option>
            </select>
            <span id="taxaRef" class="rate-badge">Ref: 0,00% a.m.</span>
        </div>
        <div class="col">
            <label>Valor da Operação (R$)</label>
            <input type="text" id="valorProposta" value="0,00" onkeyup="mascaraMoeda(this); calcular()">
        </div>
        <div class="col">
            <label>Prazo (Meses)</label>
            <input type="number" id="prazoMeses" value="0" onchange="calcular()">
        </div>
        <div class="col">
            <label>Modalidade</label>
            <select id="modalidade" onchange="calcular()">
                <option value="Urbano">Urbano</option>
                <option value="Rural">Rural</option>
                <option value="PJ">Pessoa Jurídica</option>
            </select>
        </div>
    </div>

    <div class="section-title">3. Informações Financeiras</div>
    <div class="row">
        <div class="col">
            <label>Renda Mensal (Conglomerado)</label>
            <input type="text" id="rendaMensal" value="0,00" onkeyup="mascaraMoeda(this); calcular()">
        </div>
        <div class="col">
            <label>Patrimônio (Conglomerado)</label>
            <input type="text" id="patrimonio" value="0,00" onkeyup="mascaraMoeda(this); calcular()">
        </div>
        <div class="col">
            <label>Capital (Sócio)</label>
            <input type="text" id="capital" value="0,00" onkeyup="mascaraMoeda(this); calcular()">
        </div>
    </div>
    <div class="row">
        <div class="col">
            <label>Endividamento (Cooperativa)</label>
            <input type="text" id="endividamentoCoop" value="0,00" onkeyup="mascaraMoeda(this); calcular()">
        </div>
        <div class="col">
            <label>Endividamento SCR (1 ano)</label>
            <input type="text" id="endividamentoSCR" value="0,00" onkeyup="mascaraMoeda(this); calcular()">
        </div>
        <div class="col">
            <label>SCR (Acima de 1 ano)</label>
            <input type="text" id="endividamentoSCRAcima" value="0,00" onkeyup="mascaraMoeda(this); calcular()">
        </div>
    </div>

    <div class="section-title">4. Variáveis de Relacionamento</div>
    <div class="row">
        <div class="col" style="flex: 2;">
            <label>Produtos e Serviços (Selecione)</label>
            <div class="checkbox-grid">
                <div class="checkbox-item"><label><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Cartão</span></label></div>
                <div class="checkbox-item"><label><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Internet Banking</span></label></div>
                <div class="checkbox-item"><label><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Seguro</span></label></div>
                <div class="checkbox-item"><label><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Consórcio</span></label></div>
                <div class="checkbox-item"><label><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Aplicação</span></label></div>
                <div class="checkbox-item"><label><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Empréstimo</span></label></div>
                <div class="checkbox-item"><label><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Boleto</span></label></div>
                <div class="checkbox-item"><label><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Limite Conta</span></label></div>
                <div class="checkbox-item"><label><input type="checkbox" class="prod-check" onchange="calcular()"> <span>Máquina de cartão</span></label></div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <label>Risco do Sócio</label>
            <select id="riscoSocio" onchange="calcular()">
                <option value="AA">AA</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="G">G</option>
                <option value="H">H</option>
                <option value="Sem risco">Sem risco</option>
            </select>
        </div>
        <div class="col">
            <label>Risco da Operação</label>
            <select id="riscoOperacao" onchange="calcular()">
                <option value="AA">AA</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="G">G</option>
                <option value="H">H</option>
            </select>
        </div>
        <div class="col">
            <label>Recebimento</label>
            <select id="recebimento" onchange="calcular()">
                <option value="nao">Não</option>
                <option value="sim">Sim</option>
            </select>
        </div>
    </div>

    <div class="result-box">
        <div class="result-header">RESULTADO DA SIMULAÇÃO</div>
        <div class="result-content">
            <div class="result-metric">
                <small>Taxa Base (a.m.)</small>
                <span class="value" id="outTaxaPadrao">0,00%</span>
            </div>
            <div class="result-metric">
                <small>Total de Bônus</small>
                <span class="value discount-value" id="outTotalDescontos">0,00%</span>
            </div>
            <div class="result-metric" style="background: #f0f7ff; border-radius:4px;">
                <small>Taxa Final (a.m.)</small>
                <span class="value" id="outTaxaFinalMes">0,00%</span>
            </div>
            <div class="result-metric">
                <small>Taxa Final (a.a.)</small>
                <span class="value" id="outTaxaFinalAno">0,00%</span>
            </div>
        </div>
        <div class="debug-row" id="debugDescontos">
            </div>
    </div>

    <div class="actions">
        <button class="btn" onclick="gerarRelatorioPopup()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
            Imprimir Relatório
        </button>
    </div>
</div>

<script>
    // --- LÓGICA DE NEGÓCIO ---
    const MODELOS = {
        "12": { taxa: 0.0220, anual: false },
        "20": { taxa: 0.0400, anual: false },
        "3614": { taxa: 0.1800, anual: true },
        "3616": { taxa: 0.1400, anual: true },
        "3618": { taxa: 0.0300, anual: false },
        "28": { taxa: 0.0400, anual: false },
        "25": { taxa: 0.0500, anual: false },
        "3620": { taxa: 0.0400, anual: false }
    };

    const TABELA_CAPITAL_ENDIVIDAMENTO = [{min:0,val:0.10},{min:0.05,val:0.07},{min:0.10,val:0.035},{min:0.21,val:0.00}];
    const TABELA_ENDIVIDAMENTO_PATRIMONIO = [{min:0,val:0.07},{min:0.2,val:0.045},{min:0.4,val:0.03},{min:0.6,val:0.015},{min:1.0,val:0.00}];
    const TABELA_PRODUTOS = [{min:0,val:0.00},{min:1,val:0.0125},{min:2,val:0.0250},{min:3,val:0.0375},{min:4,val:0.0500}];
    const TABELA_TEMPO_ASSOC = [{min:0,val:0.00},{min:1,val:0.015},{min:5,val:0.030},{min:10,val:0.050}];
    const TABELA_PRAZO_OP = [{min:0,val:0.04},{min:13,val:0.03},{min:25,val:0.02},{min:37,val:0.01},{min:49,val:0.00}];
    const TABELA_ENDIV_RENDA_URBANO = [{min:0,val:0.07},{min:0.1,val:0.04},{min:0.2,val:0.02},{min:0.3,val:0.00}];
    const TABELA_PRONAF_RURAL = [{min:0,val:0.07},{min:0.3,val:0.04},{min:0.5,val:0.02},{min:0.7,val:0.00}];

    // --- UTILS ---
    function mascaraCpfCnpj(i) {
        var v = i.value.replace(/\D/g, "");
        if (v.length > 14) v = v.slice(0, 14);
        if (v.length <= 11) { 
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        } else { 
            v = v.replace(/^(\d{2})(\d)/, "$1.$2");
            v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
            v = v.replace(/\.(\d{3})(\d)/, ".$1/$2");
            v = v.replace(/(\d{4})(\d)/, "$1-$2");
        }
        i.value = v;
    }

    function mascaraMoeda(i) {
        let v = i.value.replace(/\D/g,'');
        v = (v/100).toFixed(2) + '';
        v = v.replace(".", ",");
        v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        i.value = v;
    }

    function parseCurrency(str) {
        if (!str) return 0;
        return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
    }

    function procvAproximado(valor, tabela) {
        let resultado = 0;
        for (let i = 0; i < tabela.length; i++) {
            if (valor >= tabela[i].min) resultado = tabela[i].val;
            else break;
        }
        return resultado;
    }

    function getDescontoRisco(letra) {
        const tabela = { "AA": 0.05, "A": 0.05, "B": 0.05, "C": 0.02, "Sem risco": 0.00 };
        return tabela[letra] || 0;
    }

    function formatPercent(val) {
        return (val * 100).toFixed(2).replace('.', ',') + '%';
    }

    // --- FUNÇÃO DE IMPRESSÃO (NOVA) ---
    function gerarRelatorioPopup() {
        // 1. Clonar o container para pegar o HTML limpo
        const container = document.querySelector('.container');
        const clone = container.cloneNode(true);
        
        // 2. Transferir valores digitados (inputs não levam valor no clone automaticamente)
        const origInputs = container.querySelectorAll('input, select');
        const cloneInputs = clone.querySelectorAll('input, select');
        
        for (let i = 0; i < origInputs.length; i++) {
            const elOrig = origInputs[i];
            const elClone = cloneInputs[i];
            
            if (elOrig.tagName === 'SELECT') {
                elClone.value = elOrig.value;
                // Força o atributo selected para aparecer na impressão
                const options = elClone.querySelectorAll('option');
                options.forEach(opt => {
                    if (opt.value == elOrig.value) opt.setAttribute('selected', 'true');
                });
            } else if (elOrig.type === 'checkbox' || elOrig.type === 'radio') {
                if (elOrig.checked) elClone.setAttribute('checked', 'true');
            } else {
                elClone.setAttribute('value', elOrig.value);
            }
        }
        
        // 3. Remover o botão de imprimir do clone
        const actions = clone.querySelector('.actions');
        if (actions) actions.remove();

        // 4. Montar o HTML da nova janela
        const cssOriginal = document.querySelector('style').innerHTML;
        const htmlContent = `
            <html>
            <head>
                <title>Relatório de Crédito</title>
                <style>
                    ${cssOriginal}
                    /* Força estilos de impressão */
                    body { background: white; margin: 0; padding: 20px; }
                    .container { box-shadow: none; padding: 0; max-width: 100%; border: none; }
                    .actions, .no-print { display: none !important; }
                    /* Remove bordas de inputs para parecer texto fixo */
                    input, select { border: none !important; background: transparent !important; font-weight: bold; appearance: none; -webkit-appearance: none; padding: 0; color: #000; }
                    /* Ajustes visuais */
                    .section-title { color: #000; border-color: #666; background: #eee; }
                    h1 { color: #000; }
                </style>
            </head>
            <body>
                ${clone.outerHTML}
                <script>
                    window.onload = function() {
                        setTimeout(() => { window.print(); window.close(); }, 500);
                    };
                <\/script>
            </body>
            </html>
        `;

        // 5. Abrir Popup
        const printWin = window.open('', '_blank', 'width=900,height=800');
        if (printWin) {
            printWin.document.write(htmlContent);
            printWin.document.close(); // Importante para o navegador terminar de carregar
        } else {
            alert('Por favor, permita popups para este site para gerar o relatório.');
        }
    }

    // --- CALCULA ---
    function calcular() {
        document.getElementById('dataHoje').innerText = new Date().toLocaleDateString('pt-BR');

        const modeloId = document.getElementById('modelo').value;
        const valorProposta = parseCurrency(document.getElementById('valorProposta').value);
        const prazoMeses = parseInt(document.getElementById('prazoMeses').value) || 0;
        const rendaMensal = parseCurrency(document.getElementById('rendaMensal').value);
        const patrimonio = parseCurrency(document.getElementById('patrimonio').value);
        const capital = parseCurrency(document.getElementById('capital').value);
        const endivSocio = parseCurrency(document.getElementById('endividamentoCoop').value);
        const endivSCR = parseCurrency(document.getElementById('endividamentoSCR').value);
        
        const modeloDados = MODELOS[modeloId];
        let taxaBaseMes = 0;
        let taxaBaseAno = 0;

        if (modeloDados.anual) {
            taxaBaseAno = modeloDados.taxa;
            taxaBaseMes = Math.pow((1 + modeloDados.taxa), (1/12)) - 1;
        } else {
            taxaBaseMes = modeloDados.taxa;
            taxaBaseAno = Math.pow((1 + modeloDados.taxa), 12) - 1;
        }

        document.getElementById('taxaRef').innerText = `Ref: ${formatPercent(taxaBaseMes)} a.m. | ${formatPercent(taxaBaseAno)} a.a.`;

        let totalBonus = 0;
        let debug = [];

        let ratioCap = (endivSCR > 0) ? (capital + valorProposta) / endivSCR : 999;
        let descCap = procvAproximado(ratioCap, TABELA_CAPITAL_ENDIVIDAMENTO);
        totalBonus += descCap;
        debug.push(`Cap x Endiv: ${formatPercent(descCap)}`);

        let ratioPat = (patrimonio > 0) ? (valorProposta + endivSocio) / patrimonio : 999;
        let descPat = procvAproximado(ratioPat, TABELA_ENDIVIDAMENTO_PATRIMONIO);
        totalBonus += descPat;
        debug.push(`Endiv x Patr: ${formatPercent(descPat)}`);

        const qtdProd = document.querySelectorAll('.prod-check:checked').length;
        let descProd = procvAproximado(qtdProd, TABELA_PRODUTOS);
        totalBonus += descProd;
        debug.push(`Produtos: ${formatPercent(descProd)}`);

        let descRiscoS = getDescontoRisco(document.getElementById('riscoSocio').value);
        totalBonus += descRiscoS;
        
        let descRiscoO = getDescontoRisco(document.getElementById('riscoOperacao').value);
        totalBonus += descRiscoO;
        debug.push(`Risco S/O: ${formatPercent(descRiscoS)} / ${formatPercent(descRiscoO)}`);

        let descRec = document.getElementById('recebimento').value === 'sim' ? 0.02 : 0.00;
        totalBonus += descRec;

        let anosAssoc = 0;
        const dataStr = document.getElementById('dataAssociacao').value;
        if (dataStr) {
            anosAssoc = (new Date() - new Date(dataStr)) / (1000 * 60 * 60 * 24 * 365);
        }
        let descTempo = procvAproximado(anosAssoc, TABELA_TEMPO_ASSOC);
        totalBonus += descTempo;
        debug.push(`Tempo (${anosAssoc.toFixed(1)}a): ${formatPercent(descTempo)}`);

        let descPrazo = procvAproximado(prazoMeses, TABELA_PRAZO_OP);
        totalBonus += descPrazo;
        debug.push(`Prazo: ${formatPercent(descPrazo)}`);

        let ratioCapac = 0;
        if (rendaMensal > 0 && prazoMeses > 0) {
            ratioCapac = ((endivSocio / 12) + (valorProposta / prazoMeses)) / rendaMensal;
        }
        const mod = document.getElementById('modalidade').value;
        let descMod = procvAproximado(ratioCapac, (mod === 'Urbano') ? TABELA_ENDIV_RENDA_URBANO : TABELA_PRONAF_RURAL);
        totalBonus += descMod;
        debug.push(`Modalidade: ${formatPercent(descMod)}`);

        let taxaFinalMes = 0;
        let taxaFinalAno = 0;

        if (modeloDados.anual) {
            taxaFinalAno = taxaBaseAno * (1 - totalBonus);
            if (taxaFinalAno < 0) taxaFinalAno = 0;
            taxaFinalMes = Math.pow((1 + taxaFinalAno), (1/12)) - 1;
        } else {
            taxaFinalMes = taxaBaseMes * (1 - totalBonus);
            if (taxaFinalMes < 0) taxaFinalMes = 0;
            taxaFinalAno = Math.pow((1 + taxaFinalMes), 12) - 1;
        }

        document.getElementById('outTaxaPadrao').innerText = formatPercent(taxaBaseMes);
        document.getElementById('outTotalDescontos').innerText = formatPercent(totalBonus);
        document.getElementById('outTaxaFinalMes').innerText = formatPercent(taxaFinalMes);
        document.getElementById('outTaxaFinalAno').innerText = formatPercent(taxaFinalAno);
        
        document.getElementById('debugDescontos').innerHTML = `<strong>Bônus:</strong> ` + debug.join(' | ');
    }

    window.onload = calcular;
</script>

</body>
</html>